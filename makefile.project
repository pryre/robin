PROJECT_NAME = robin

BUILD_REV_OK := 0

ifeq ($(BOARD_TYPE),naze32_rev5)
BUILD_REV_OK := 1
endif
ifeq ($(BOARD_TYPE),naze32_rev6)
BUILD_REV_OK := 1
endif

ifeq ($(BUILD_REV_OK),0)
$(error Unsupported board revision: $(BOARD_TYPE))
endif

$(info Building for board revision: $(BOARD_TYPE))

GEN_PARAMS := $(shell python3 lib/param_generator/gen_params.py >&2; echo $$?)
#$(info $$GEN_PARAMS is [${GEN_PARAMS}])
ifeq ($(GEN_PARAMS),"0")
    $(error Cannot continue make without parameters generated)
endif

GIT_VERSION_FLIGHT := $(shell git describe --abbrev=8 --always | sed 's/^ *//g' | head -c 8)
GIT_VERSION_OS := $(shell git submodule status | grep BreezySTM32 | sed 's/^ *//g' | head -c 8)
GIT_VERSION_MAVLINK := $(shell git submodule status | grep mavlink | sed 's/^ *//g' | head -c 8)

EEPROM_CONF_VERSION := $(shell date +'%s')

# Contains your setup() and loop()
PROJECT_SRC_FILES = ./src/main.c \
					./src/params.c \
					./src/safety.c \
					./src/mavlink_system.c \
					./src/mavlink_receive.c \
					./src/mavlink_transmit.c \
					./src/calibration.c \
					./src/sensors.c \
					./src/estimator.c \
					./src/pid_controller.c \
					./src/controller.c \
					./src/mixer.c \
					./src/mixer.c

# Mavlink receive handlers
PROJECT_SRC_FILES += ./src/mavlink_handlers/mavlink_handle_heartbeat.c \
					 ./src/mavlink_handlers/mavlink_handle_param_request_list.c \
					 ./src/mavlink_handlers/mavlink_handle_param_request_read.c \
					 ./src/mavlink_handlers/mavlink_handle_param_set.c \
					 ./src/mavlink_handlers/mavlink_handle_command_long.c \
					 ./src/mavlink_handlers/mavlink_handle_set_attitude_target.c \
					 ./src/mavlink_handlers/mavlink_handle_att_pos_mocap.c \
					 ./src/mavlink_handlers/mavlink_handle_mission_request_list.c \
					 ./src/mavlink_handlers/mavlink_handle_actuator_control_target.c \
					 ./src/mavlink_handlers/mavlink_handle_hil_sensor.c \
					 ./src/mavlink_handlers/mavlink_handle_timesync.c

#  Mavlink receive command handlers
PROJECT_SRC_FILES += ./src/mavlink_handlers/mavlink_handle_command_long_preflight_calibration.c \
					 ./src/mavlink_handlers/mavlink_handle_command_long_set_mode.c \
					 ./src/mavlink_handlers/mavlink_handle_command_long_do_motor_test.c \
					 ./src/mavlink_handlers/mavlink_handle_command_long_request_protocol_version.c \
					 ./src/mavlink_handlers/mavlink_handle_command_long_request_autopilot_capabilities.c \
					 ./src/mavlink_handlers/mavlink_handle_command_long_get_home_position.c \
					 ./src/mavlink_handlers/mavlink_handle_command_long_preflight_storage.c \
					 ./src/mavlink_handlers/mavlink_handle_command_long_reboot_shutdown.c \
					 ./src/mavlink_handlers/mavlink_handle_command_long_component_arm_disarm.c

# Calibration Handlers
PROJECT_SRC_FILES += ./src/calibrations/calibrations_accel.c \
					 ./src/calibrations/calibrations_barometer.c \
					 ./src/calibrations/calibrations_ground_pressure.c \
					 ./src/calibrations/calibrations_gyro.c \
					 ./src/calibrations/calibrations_interference.c \
					 ./src/calibrations/calibrations_level_horizon.c \
					 ./src/calibrations/calibrations_magnetometer.c \
					 ./src/calibrations/calibrations_rc.c\
					 ./src/calibrations/calibrations_esc.c

# Board specific drivers
ifeq ($(BOARD_TYPE),naze32_rev5)
PROJECT_SRC_FILES += ./src/drivers/naze32_common/drv_system.c \
					 ./src/drivers/naze32_common/drv_status_io.c \
					 ./src/drivers/naze32_common/drv_flash.c \
					 ./src/drivers/naze32_common/drv_comms.c \
					 ./src/drivers/naze32_common/drv_pwm.c \
					 ./src/drivers/naze32_common/drv_hmc5883l.c \
					 ./src/drivers/naze32_common/drv_bmp280.c \
					 ./src/drivers/naze32_common/drv_mpu.c \
					 ./src/drivers/naze32_common/drv_mpu6050.c \
					 ./src/drivers/naze32_common/drv_mpu6500.c \
					 ./src/drivers/naze32_rev5/drv_imu.c \
					 ./src/drivers/naze32_rev5/drv_baro.c \
					 ./src/drivers/naze32_rev5/drv_mag.c
endif
ifeq ($(BOARD_TYPE),naze32_rev6)
PROJECT_SRC_FILES += ./src/drivers/naze32_common/drv_system.c \
					 ./src/drivers/naze32_common/drv_status_io.c \
					 ./src/drivers/naze32_common/drv_flash.c \
					 ./src/drivers/naze32_common/drv_comms.c \
					 ./src/drivers/naze32_common/drv_pwm.c \
					 ./src/drivers/naze32_common/drv_hmc5883l.c \
					 ./src/drivers/naze32_common/drv_bmp280.c \
					 ./src/drivers/naze32_common/drv_mpu.c \
					 ./src/drivers/naze32_common/drv_mpu6050.c \
					 ./src/drivers/naze32_common/drv_mpu6500.c \
					 ./src/drivers/naze32_rev6/drv_imu.c \
					 ./src/drivers/naze32_rev6/drv_baro.c \
					 ./src/drivers/naze32_rev6/drv_mag.c
endif

# Parameter Generation
PROJECT_DIR_PARAM_GEN = ./lib/param_generator
PROJECT_SRC_PARAM_GEN = $(PROJECT_DIR_PARAM_GEN)/param_gen.c

# Drivers, etc.
PROJECT_BREEZY_FILES = $(F1_DIR)/i2c_stm32f10x.c \
					   $(F1_DIR)/adc.c
					   #$(F1_DIR)/pwm.c
					   #$(F1_DIR)/drivers/mpu.c

# Math Libs.
PROJECT_DIR_LIBFIXMATH = ./lib/libfixmath/libfixmath
PROJECT_DIR_LIBFIXMATRIX = ./lib/libfixmatrix

PROJECT_SRC_LIBFIXMATH = $(PROJECT_DIR_LIBFIXMATH)/fix16.c \
							$(PROJECT_DIR_LIBFIXMATH)/fix16_exp.c \
							$(PROJECT_DIR_LIBFIXMATH)/fix16_sqrt.c \
							$(PROJECT_DIR_LIBFIXMATH)/fix16_str.c \
							$(PROJECT_DIR_LIBFIXMATH)/fix16_trig.c \
							$(PROJECT_DIR_LIBFIXMATH)/fract32.c \
							$(PROJECT_DIR_LIBFIXMATH)/uint32.c


PROJECT_SRC_LIBFIXMATRIX = $(PROJECT_DIR_LIBFIXMATRIX)/fixarray.c \
							$(PROJECT_DIR_LIBFIXMATRIX)/fixmatrix.c \
							$(PROJECT_DIR_LIBFIXMATRIX)/fixquat.c \
							$(PROJECT_DIR_LIBFIXMATRIX)/fixstring.c \
							$(PROJECT_DIR_LIBFIXMATRIX)/fixvector2d.c \
							$(PROJECT_DIR_LIBFIXMATRIX)/fixvector3d.c
